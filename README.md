# JQF: Generator-based Structured Fuzzing for Java 

JQF is built on top of [junit-quickcheck](https://github.com/pholser/junit-quickcheck), which itself lets you write [Quickcheck](http://www.cse.chalmers.se/~rjmh/QuickCheck/manual.html)-like **generators** and properties in a [Junit](http://junit.org)-style test class. JQF enables better input generation using **coverage-guided** fuzzing tools such as [AFL](http://lcamtuf.coredump.cx/afl). 

JQF has been successful in [discovering a number of bugs in widely used open-source software](https://github.com/rohanpadhye/jqf/wiki/Bug-trophy-case) such as OpenJDK, Apache Maven and the Google Closure Compiler.

## What is *structured fuzzing*?

Conventional fuzzing tools like [AFL](http://lcamtuf.coredump.cx/afl) and [libFuzzer](https://llvm.org/docs/LibFuzzer.html) treat the input as a sequence of bytes. If the test program expects highly structured inputs, such as XML documents or JavaScript programs, then mutating byte-arrays often results in syntactically invalid inputs; the core of the test program remains untested.

**Structured fuzzing** tools like **JQF** and others perform mutations in the space of *syntactically valid* inputs, by leveraging domain-specific knowledge of the input format.

### What is *generator-based* structured fuzzing?

Structured fuzzing tools need a way to understand the input format. Some tools use [grammars](https://embed.cs.utah.edu/csmith/) and [protobufs](https://github.com/google/libprotobuf-mutator) as a declarative specification. JQF uses an imperative approach: arbitrary *generator* programs. A generator for type `T` is a function which when invoked returns a random instance of type `T`. For example, a generator of type `Date` returns randomly-generated `Date` objects. One can easily write generators for more complex types, such as [XML documents](https://github.com/rohanpadhye/jqf/blob/master/examples/src/main/java/edu/berkeley/cs/jqf/examples/xml/XmlDocumentGenerator.java), [JavaScript programs](https://github.com/rohanpadhye/jqf/blob/master/examples/src/main/java/edu/berkeley/cs/jqf/examples/js/JavaScriptCodeGenerator.java), [JVM class files](https://github.com/rohanpadhye/jqf/blob/master/examples/src/main/java/edu/berkeley/cs/jqf/examples/bcel/JavaClassGenerator.java), SQL queries, HTTP requests, and many more -- this is **generator-based structured fuzzing**. However, simply sampling random inputs of type `T` is not usually very effective, since the generator does not know if the inputs it is producing are any good.

**JQF uses code-coverage feedback to bias the pseudo-random source that backs your generator**, thereby encouraging the production of inputs that are both syntactically valid and find bugs deep in your test program.

## Quickstart

First, build JQF and the AFL proxy:
```
$ git clone https://github.com/rohanpadhye/jqf
$ jqf/setup.sh
```

Then, write a Junit-like test class annotated with `@RunWith(JQF.class)` and write some test methods annotated with `@Fuzz`. The arguments to the test methods will be generated by JQF:

```java
@RunWith(JQF.class)
public class DateFormatterTest {

    /* Input params will be generated by JQF, many times. */
    /* Exceptions listed in the "throws" clause are considered normal (tests will pass on throw) */
    @Fuzz
    public void fuzzSimple(Date date, String format) throws IllegalArgumentException {
        // Create a simple date formatter using the input format string
        // May throw IllegalArgumentException for invalid formats
        DateFormat df = new SimpleDateFormat(format);

        // Format the date using the constructed formatter
        df.format(date);
    }
}
```

Compile with JQF on the classpath (using the provided handy script):
```bash
$ javac -cp $(jqf/scripts/classpath.sh) DateFormatterTest.java
```


Fuzz the method `fuzzSimple` with AFL:
```bash
$ jqf/bin/jqf-afl-fuzz DateFormatterTest fuzzSimple
```

Grab a coffee while AFL does its thing:

![AFL status screen](https://rohanpadhye.github.io/jqf/images/AFL-DateFormatter.png)

Ooh! We found some crashes. Let's reproduce one such test case and see what the error was.

```
$ jqf/bin/jqf-repro DateFormatterTest fuzzSimple fuzz-results/crashes/id:000000
java.lang.ArrayIndexOutOfBoundsException: 127
	at java.text.SimpleDateFormat.subFormat(SimpleDateFormat.java)
	at java.text.SimpleDateFormat.format(SimpleDateFormat.java)
	at java.text.SimpleDateFormat.format(SimpleDateFormat.java)
	at java.text.DateFormat.format(DateFormat.java)
```

This shouldn't happen! `DateFormat.format()` does not specify that it will throw `ArrayIndexOutOfBoundsException`. Time to file a [bug report](https://github.com/rohanpadhye/jqf/wiki/Bug-trophy-case) :-)

## Using JQF with Maven

Do you use Apache Maven to build your project? Great! Then you don't need to clone/build JQF and mess with classpaths and shell scripts.

Simply add a test-dependency to the JQF API in your `pom.xml` file as so:

```xml
<dependency>
    <groupId>edu.berkeley.cs.jqf</groupId>
    <artifactId>jqf-fuzz</artifactId>
    <version>1.0-beta-1</version>
    <scope>test</scope>
</dependency>
```

You can now have your JQF test classes be part of your standard JUnit test suite. When not run as a stand-alone fuzzing job on the command-line, these tests will be run like regular `junit-quickcheck` tests, i.e. 100 inputs will be generated randomly without feedback per `@Fuzz` annotated method.

You might also want to checkout the [JQF Maven Plugin](https://github.com/rohanpadhye/jqf/wiki/JQF-Maven-Plugin) that lets you fuzz your application using `mvn jqf:fuzz` instead of having to clone this repo and run shell scripts.

## Documentation

The [JQF wiki](https://github.com/rohanpadhye/jqf/wiki) contains lots more documentation including:
- [Writing a JQF test](https://github.com/rohanpadhye/jqf/wiki/Writing-a-JQF-test)
- [Fuzzing with AFL](https://github.com/rohanpadhye/jqf/wiki/Fuzzing-with-AFL)
- [Using a custom fuzz guidance](https://github.com/rohanpadhye/jqf/wiki/The-Guidance-interface)
- [Performance Benchmarks](https://github.com/rohanpadhye/jqf/wiki/Performance-benchmarks)


## Contact the developers

We want your feedback! (haha, get it? get it?) 

If you've found a bug in JQF or are having trouble getting JQF to work, please open an issue on the [issue tracker](https://github.com/rohanpadhye/jqf/issues). You can also use this platform to post feature requests.

If it's some sort of fuzzing emergency you can always send an email to the main developer: [Rohan Padhye](https://people.eecs.berkeley.edu/~rohanpadhye).
