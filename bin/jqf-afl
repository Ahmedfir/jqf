#!/bin/bash

# Figure out script absolute path
pushd `dirname $0` > /dev/null
SCRIPT_DIR=`pwd`
popd > /dev/null

ROOT_DIR=`dirname $SCRIPT_DIR`

# Check arguments
if [ $# -lt 3 ]; then
  echo "Usage: $0 TEST_CLASS TEST_METHOD INPUT_FILE" >&2
  exit 1
fi

# Ensure that proxy is built
if [ ! -f "$ROOT_DIR/bin/afl-proxy" ]; then
  echo "The AFL proxy is not built! Make sure to run scripts/setup.sh or run 'make' in afl/" >&2
  exit 2
fi

driver="edu.berkeley.cs.jqf.fuzz.drivers.AFLDriver"

if [ $1 = '-r' ]; then
  driver="edu.berkeley.cs.jqf.fuzz.drivers.AFLRedundancyDriver"
  shift 1
fi


class=$1
method=$2
input=$3

tmpdir=$(mktemp -d /tmp/jqf.XXX)

a2j="$tmpdir/a2j"
j2a="$tmpdir/j2a"

mkfifo "$a2j"
mkfifo "$j2a"

# Run the AFL driver in the background
"$ROOT_DIR/scripts/jqf-driver.sh" \
  $driver $class $method $input $a2j $j2a \
  1> /dev/null 2> /dev/null &

# Run the proxy
"$ROOT_DIR/bin/afl-proxy" $a2j $j2a


